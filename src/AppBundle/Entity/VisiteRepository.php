<?php

namespace AppBundle\Entity;

use Doctrine\ORM\EntityRepository;

/**
 * VisiteRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class VisiteRepository extends EntityRepository
{
    
    public function findAllAjax($start, $end, $sCol, $sdir, $search) {
        $qb = $this->getEntityManager()
            ->createQuery(
                'SELECT r.id, v.immatriculation, v.typeChassis, v.chassis, r.revisite, r.statut, p.nom, p.prenom,pi.numero as piste, ca.numero as caisse FROM AppBundle:Visite r LEFT JOIN r.vehicule v LEFT JOIN v.proprietaire p LEFT JOIN r.chaine c LEFT JOIN c.piste pi LEFT JOIN c.caisse ca'
                    . ' WHERE v.immatriculation like :search '
                    . ' ORDER BY '.$sCol.' '.$sdir)
            ->setParameter('search', '%'.$search.'%')
            ->setFirstResult($start)
            ->setMaxResults($end);
        $arrayAss = $qb->execute(null, \Doctrine\ORM\Query::HYDRATE_SCALAR);
        return $arrayAss;
    }
    
    public function findQuittancesAjax($start, $end, $sCol, $sdir, $search, $caisse) {
        $controle = ($caisse == 0) ? 'ca.id > :caisse ' : ' ca.id = :caisse ';
        $qb = $this->getEntityManager()
            ->createQuery(
                'SELECT r.id, v.immatriculation, r.revisite, p.nom, p.prenom, ca.numero as caisse, ca.ouvert FROM AppBundle:Visite r LEFT JOIN r.quittance q LEFT JOIN r.vehicule v LEFT JOIN v.proprietaire p LEFT JOIN r.chaine c LEFT JOIN c.caisse ca '
                    . ' WHERE r.contreVisite = false AND (v.immatriculation like :search OR q.numero like :search) AND '.$controle
                    . ' ORDER BY '.$sCol.' '.$sdir)
            ->setParameter('search', '%'.$search.'%')
            ->setParameter('caisse', $caisse)
            ->setFirstResult($start)
            ->setMaxResults($end);
        $arrayAss = $qb->execute(null, \Doctrine\ORM\Query::HYDRATE_SCALAR);
        return $arrayAss;
    }
    
    public function countRows() {
        $qb = $this->createQueryBuilder('c');
        $qb->select('count(c.id)');
        return  $qb->getQuery()->getSingleScalarResult();
    }
    
    public function countRowsFiltre($search) {
        $qb = $this->createQueryBuilder('c');
        $qb->select('count(c.id)')->leftJoin('c.vehicule', 'v')->where('v.immatriculation like :search')->setParameter('search', '%'.$search.'%');
        return  $qb->getQuery()->getSingleScalarResult();
    }
    
    public function countQuittanceRows($caisse) {
        $controle = ($caisse == 0) ? 'ca.id > :caisse ' : ' ca.id = :caisse ';
        $qb = $this->getEntityManager()
            ->createQuery(
                'SELECT count(r.id) FROM AppBundle:Visite r LEFT JOIN r.chaine c LEFT JOIN c.caisse ca '
                    . ' WHERE r.contreVisite = false AND r.statut < 2 AND '.$controle)
               ->setParameter('caisse', $caisse);
        return  $qb->getSingleScalarResult();
    }
    
    public function countQuittanceRowsFiltre($caisse, $search) {
        $controle = ($caisse == 0) ? 'ca.id > :caisse ' : ' ca.id = :caisse ';
        $qb = $this->getEntityManager()
            ->createQuery(
                'SELECT count(r.id) FROM AppBundle:Visite r LEFT JOIN r.chaine c LEFT JOIN c.caisse ca LEFT JOIN r.vehicule v '
                    . ' WHERE r.contreVisite = false AND r.statut < 2 AND v.immatriculation like :search AND '.$controle)
               ->setParameter('caisse', $caisse)->setParameter('search', '%'.$search.'%');
        return  $qb->getSingleScalarResult();
    }
    
    public function trouverParLibelle($libelle) {
        try{ 
            $result = $this->getEntityManager()
            ->createQuery(
                'SELECT r FROM AppBundle:Carrosserie r WHERE r.libelle = :libelle'
            )->setParameter("libelle",$libelle)
            ->getSingleResult();
       }catch (\Doctrine\ORM\NonUniqueResultException $ex) {
            $result = null;
        }
        catch (\Doctrine\ORM\NoResultException $ex){
            $result = null;
        }
        
        return $result; 
    } 
    
    public function nbVisitesNonTerminees($chaine) {
        $result = $this->getEntityManager()
            ->createQuery(
                'SELECT count(r.id) FROM AppBundle:Visite r LEFT JOIN r.chaine c WHERE c.id = :chaine AND r.statut < 2'
            )->setParameter("chaine",$chaine)
            ->getSingleScalarResult(); 
        return $result; 
    }
    
    public function visiteParent($vehicule) {
        try{ 
            $result = $this->getEntityManager()
            ->createQuery(
                'SELECT r FROM AppBundle:Visite r LEFT JOIN r.vehicule v WHERE v.id = :vehicule AND r.statut = 3'
            )->setParameter("vehicule",$vehicule)
            ->getSingleResult();
       }catch (\Doctrine\ORM\NonUniqueResultException $ex) {
            $result = -1;
        }
        catch (\Doctrine\ORM\NoResultException $ex){
            $result = null;
        }
        
        return $result; 
    } 
    
    public function derniereVisite($vehicule, $encours = 0) {
        $qb = $this->getEntityManager()
            ->createQuery(
                'SELECT r FROM AppBundle:Visite r LEFT JOIN r.vehicule v '
                    . ' WHERE v.id = :vehicule AND r.id <> :encours AND r.statut < 5'
                    . ' ORDER BY r.date DESC')
            ->setParameter('vehicule', $vehicule)
            ->setParameter('encours', $encours);
        $result = $qb->getResult();
        return  $result!= null ? $result[0] : null;
    }
    
    public function findControlesAjax($start, $end, $sCol, $sdir, $search, $piste) {
        $controle = ($piste == 0) ? 'pi.id > :piste ' : 'pi.id = :piste ';
        $qb = $this->getEntityManager()
            ->createQuery(
                'SELECT r.id, r.contreVisite, r.contreVisiteVisuelle, v.immatriculation, v.typeChassis, r.revisite, r.statut, p.nom, p.prenom,pi.numero as piste, v.id as vehicule FROM AppBundle:Visite r LEFT JOIN r.vehicule v LEFT JOIN v.proprietaire p LEFT JOIN r.chaine c LEFT JOIN c.piste pi '
                    . ' WHERE r.statut IN (1,2,3,4) AND v.immatriculation like :search AND '.$controle
                    . ' ORDER BY '.$sCol.' '.$sdir)
            ->setParameter('search', '%'.$search.'%')
            ->setParameter('piste', $piste)
            ->setFirstResult($start)
            ->setMaxResults($end);
        $arrayAss = $qb->execute(null, \Doctrine\ORM\Query::HYDRATE_SCALAR);
        return $arrayAss;
    }
    
    public function countControlesRows($piste) {
        $controle = ($piste == 0) ? 'pi.id > :piste ' : ' pi.id = :piste ';
        $qb = $this->getEntityManager()
            ->createQuery(
                'SELECT count(r.id) FROM AppBundle:Visite r LEFT JOIN r.chaine c LEFT JOIN c.piste pi '
                    . ' WHERE r.statut IN (1,2,3) AND '.$controle)
               ->setParameter('piste', $piste);
        return  $qb->getSingleScalarResult();
    }
    
    public function countControlesRowsFiltre($piste, $search) {
        $controle = ($piste == 0) ? 'pi.id > :piste ' : ' pi.id = :piste ';
        $qb = $this->getEntityManager()
            ->createQuery(
                'SELECT count(r.id) FROM AppBundle:Visite r LEFT JOIN r.chaine c LEFT JOIN c.piste pi '
                    . ' WHERE r.statut IN (1,2,3) AND v.immatriculation like :search AND '.$controle)
               ->setParameter('piste', $piste)->setParameter('search', '%'.$search.'%');
        return  $qb->getSingleScalarResult();
    }
    
    public function nbVisitesParStatut() {
        $result = $this->getEntityManager()
            ->createQuery(
                'SELECT r.statut, count(r.id) FROM AppBundle:Visite r GROUP BY r.statut ORDER BY r.statut asc'
            )
            ->getResult();
        return $result; 
    }
}
